<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hava Durumu Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica', Arial, sans-serif;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }
    
    .weather-container {
      text-align: center;
      padding: 30px;
      border-radius: 0;
      background: transparent;
      min-width: 300px;
    }
    
    .city-name {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .weather-icon {
      font-size: 80px;
      margin: 20px 0;
    }
    
    .temperature {
      font-size: 64px;
      font-weight: 700;
      margin: 20px 0;
    }
    
    .description {
      font-size: 24px;
      font-weight: 400;
      margin-bottom: 20px;
      text-transform: capitalize;
    }
    
    .details {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      padding-top: 20px;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .detail-label {
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-size: 20px;
      font-weight: 600;
    }
    
    .loading, .error {
      font-size: 24px;
      text-align: center;
    }
    
    .error {
      color: inherit;
    }
  </style>
</head>
<body>
  <div class="weather-container" id="container">
    <div class="loading">Hava durumu yÃ¼kleniyor...</div>
  </div>

  <script>
    // Get config
    const urlParams = new URLSearchParams(window.location.search);
    const configStr = urlParams.get('config');
    const config = configStr ? JSON.parse(decodeURIComponent(configStr)) : {};
    
    // Configuration
    const city = config.city || 'Istanbul';
    const units = config.units || 'metric'; // metric, imperial, standard
    const refreshInterval = (config.refreshInterval || 600) * 1000; // seconds to ms
    const textColor = config.textColor || '#ffffff';
    const backgroundColor = config.backgroundColor || 'transparent';
    const showDetails = config.showDetails !== false;
    
    console.log('Weather Widget - City:', city, 'Units:', units);
    
    document.body.style.background = backgroundColor;
    document.body.style.color = textColor;
    
    const container = document.getElementById('container');
    
    // Backend proxy kullanÄ±yoruz - API key backend'de
    const weatherApiUrl = 'http://localhost:3001/api/weather-proxy/current';
    
    // Weather icons mapping
    const weatherIcons = {
      '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
      '02d': 'â›…', '02n': 'â˜ï¸',
      '03d': 'â˜ï¸', '03n': 'â˜ï¸',
      '04d': 'â˜ï¸', '04n': 'â˜ï¸',
      '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
      '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
      '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
      '13d': 'â„ï¸', '13n': 'â„ï¸',
      '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
    };
    
    async function fetchWeather() {
      try {
        const url = `${weatherApiUrl}?city=${encodeURIComponent(city)}&units=${units}&lang=tr`;
        console.log('Weather Widget - Fetching from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Weather Widget - Success');
        displayWeather(data);
      } catch (error) {
        console.error('Weather fetch error:', error);
        container.innerHTML = `
          <div class="error">
            Hava durumu yÃ¼klenirken hata oluÅŸtu.<br>
            <small>Åehir adÄ±nÄ± kontrol edin.</small>
          </div>
        `;
      }
    }
    
    function displayWeather(data) {
      const temp = Math.round(data.main.temp);
      const feelsLike = Math.round(data.main.feels_like);
      const description = data.weather[0].description;
      const icon = weatherIcons[data.weather[0].icon] || 'ğŸŒ¤ï¸';
      const humidity = data.main.humidity;
      const windSpeed = data.wind.speed;
      const pressure = data.main.pressure;
      
      const unitSymbol = units === 'metric' ? 'Â°C' : (units === 'imperial' ? 'Â°F' : 'K');
      const windUnit = units === 'metric' ? 'm/s' : 'mph';
      
      let html = `
        <div class="city-name">${data.name}</div>
        <div class="weather-icon">${icon}</div>
        <div class="temperature">${temp}${unitSymbol}</div>
        <div class="description">${description}</div>
      `;
      
      if (showDetails) {
        html += `
          <div class="details">
            <div class="detail-item">
              <div class="detail-label">Hissedilen</div>
              <div class="detail-value">${feelsLike}${unitSymbol}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Nem</div>
              <div class="detail-value">${humidity}%</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">RÃ¼zgar</div>
              <div class="detail-value">${windSpeed} ${windUnit}</div>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // Initial fetch
    fetchWeather();
    
    // Auto refresh
    setInterval(fetchWeather, refreshInterval);
    
    // Listen for config updates
    window.addEventListener('message', (event) => {
      if (event.data.type === 'CONFIG_UPDATE') {
        location.reload();
      }
    });
  </script>
</body>
</html>

